{"version":3,"sources":["script-editor.js","index.js"],"names":["Messages","window","settings","names","infos","controller","optionLists","showSuccessAndError","data","error","enqueue","_","isString","gettext","success","apiRequest","command","options","request","extend","req","m","apiUrl","xhr","setRequestHeader","ShuupAdminConfig","csrf","then","response","text","tags","Controller","ctrl","steps","prop","currentItem","newStepItemModalInfo","removeStepItem","step","itemType","item","listName","reject","i","activateStepItem","addStepItem","identifier","activateForEdit","push","setStepItemEditorState","state","getElementById","style","display","src","frm","document","createElement","itemEditorUrl","appendChild","JSON","stringify","eventIdentifier","body","submit","receiveItemEditData","startComputation","endComputation","saveState","deleteStep","s","addNewStep","moveStep","delta","oldIndex","indexOf","newIndex","splice","promptForNewStepItem","closeNewStepItemModal","createNewStepItemFromModal","info","workflowItemList","nameMap","items","list","map","name","tag","current","partial","onclick","confirm","stepTableRows","index","condOpSelect","cond_op","withAttr","value","condOps","stepNextSelect","next","stepNexts","enabled","id","length","title","renderNewStepItemModal","modalInfo","sortBy","values","description","view","modal","href","generateItemOptions","o","children","toLowerCase","itemInfosToNameMap","itemInfos","itemInfo","zipObject","init","iSettings","condition","conditionInfos","action","actionInfos","mount","addEventListener","event","new_data","save","ScriptEditor"],"mappings":";;;AAWA,IAAMA,EAAWC,OAAOD,SAEpBE,EAAW,GACTC,EAAQ,GACRC,EAAQ,GACVC,EAAa,KACXC,EAAc,GAEpB,SAASC,EAAoBC,GACrBA,EAAKC,OACIC,EAAAA,QAAQ,CACPC,KAAAA,EAAEC,SAASJ,EAAKC,OAASD,EAAKC,MAAQI,QAAQ,sBAC9C,KAAA,UAGVL,EAAKM,SACIJ,EAAAA,QAAQ,CACPC,KAAAA,EAAEC,SAASJ,EAAKM,SAAWN,EAAKM,QAAUD,QAAQ,YAClD,KAAA,YAKlB,SAASE,EAAWC,EAASR,EAAMS,GACzBC,IAAAA,EAAUP,EAAEQ,OAAO,GAAI,CAAC,QAAWH,GAAUR,GAAQ,IACrDY,EAAMC,EAAEH,QAAQP,EAAEQ,OAAO,CACnB,OAAA,OACHjB,IAAAA,EAASoB,OACRJ,KAAAA,EACE,OAAA,SAASK,GACTC,EAAAA,iBAAiB,cAAevB,OAAOwB,iBAAiBC,QAEjET,IAMIG,OALHO,EAAAA,KAAK,SAASC,GACMA,EAAAA,IACrB,WACUlB,EAAAA,QAAQ,CAACmB,KAAMhB,QAAQ,kCAAmCiB,KAAM,YAEtEV,EAGX,SAASW,IACCC,IAAAA,EAAO,KACRC,EAAAA,MAAQZ,EAAEa,KAAK,IACfC,EAAAA,YAAcd,EAAEa,KAAK,MACrBE,EAAAA,qBAAuBf,EAAEa,KAAK,MAExB,EAAA,WAAWP,KAAK,SAASnB,GAC3ByB,EAAAA,MAAMzB,EAAKyB,SAGfI,EAAAA,eAAiB,SAASC,EAAMC,EAAUC,GACrCC,IAAAA,EAAWF,EAAW,IACvBE,EAAAA,GAAY9B,EAAE+B,OAAOJ,EAAKG,GAAW,SAASE,GACxCA,OAAAA,IAAMH,IAEbR,EAAKG,gBAAkBK,GAClBI,EAAAA,iBAAiB,KAAM,KAAM,OAIrCC,EAAAA,YAAc,SAASP,EAAMC,EAAUO,EAAYC,GAC9CP,IAAAA,EAAO,CAAC,WAAcM,GAEvBL,EADYF,EAAW,KACbS,KAAKR,GAChBO,GACKH,EAAAA,iBAAiBN,EAAMC,EAAUC,IAGzCS,EAAAA,uBAAyB,SAASC,GAC/BA,EACSC,SAAAA,eAAe,qBAAqBC,MAAMC,QAAU,SAEpDF,SAAAA,eAAe,qBAAqBC,MAAMC,QAAU,OACpDF,SAAAA,eAAe,mBAAmBG,IAAM,gBAGpDV,EAAAA,iBAAmB,SAASN,EAAMC,EAAUC,GACzCF,GAAAA,GAAQE,EAAM,CACTL,EAAAA,YAAYK,GACXe,IAAAA,EAAM5C,EAAEQ,OAAOqC,SAASC,cAAc,QAAS,CACzC,OAAA,kBACA,OAAA,OACAvD,OAAAA,EAASwD,gBAEjBC,EAAAA,YAAYhD,EAAEQ,OAAOqC,SAASC,cAAc,SAAU,CAChD,KAAA,YACA,KAAA,SACCG,MAAAA,KAAKC,UAAU,CACD3D,gBAAAA,EAAS4D,gBAChBvB,SAAAA,EACJC,KAAAA,OAGLuB,SAAAA,KAAKJ,YAAYJ,GACtBS,EAAAA,SACCf,EAAAA,wBAAuB,QAEvBd,EAAAA,YAAY,MACZc,EAAAA,wBAAuB,IAG/BgB,EAAAA,oBAAsB,SAASzD,GAC1B2B,IAAAA,EAAcH,EAAKG,cACpBA,GAIH+B,EAAAA,mBACG/B,EAAAA,YAAYxB,EAAEQ,OAAOgB,EAAa3B,IACrC2D,EAAAA,kBALQtD,MAAAA,QAAQ,oCAOjBuD,EAAAA,UAAY,WACF,EAAA,WAAY,CACZpC,MAAAA,EAAKC,WAKfoC,EAAAA,WAAa,SAAS/B,GAClBL,EAAAA,MAAMtB,EAAE+B,OAAOV,EAAKC,QAAS,SAASqC,GAChCA,OAAAA,IAAMhC,MAGhBiC,EAAAA,WAAa,WACRjC,IAOAL,EAAQD,EAAKC,QACbe,EAAAA,KARO,CACA,QAAA,GACG,WAAA,GACH,SAAA,EACH,KAAA,WACE,OAAA,QAIPf,EAAAA,MAAMA,IAEVuC,EAAAA,SAAW,SAASlC,EAAMmC,GACrBxC,IAAAA,EAAQD,EAAKC,QACbyC,EAAW/D,EAAEgE,QAAQ1C,EAAOK,GAC9BoC,IAAc,IAAdA,EACO,OAAA,EAELE,IAAAA,EAAWF,EAAWD,EACtBI,EAAAA,OAAOD,EAAU,EAAG3C,EAAM4C,OAAOH,EAAU,GAAG,IAC/CzC,EAAAA,MAAMA,IAEV6C,EAAAA,qBAAuB,SAASxC,EAAMC,GAClCH,EAAAA,qBAAqB,CAChBE,KAAAA,EACIC,SAAAA,EACH1B,MAAAA,QAAQ,WAAa,IAAM0B,KAGrCwC,EAAAA,sBAAwB,WACpB3C,EAAAA,qBAAqB,OAEzB4C,EAAAA,2BAA6B,SAASlC,GACjCmC,IAAAA,EAAOjD,EAAKI,uBACb2C,EAAAA,wBACQ,OAATE,GAGCpC,EAAAA,YAAYoC,EAAK3C,KAAM2C,EAAK1C,SAAUO,GAAY,IAI/D,SAASoC,EAAiBlD,EAAMM,EAAMC,GAC5BE,IAAAA,EAAWF,EAAW,IACtB4C,EAAUhF,EAAMoC,GAChB6C,EAAQ9C,EAAKG,GACb4C,EAAOhE,EAAE,iBAAkB+D,EAAME,IAAI,SAAS9C,GAC1C+C,IAAAA,EAAOJ,EAAQ3C,EAAKM,aAAeN,EAAKM,WAC1C0C,EAAM,KACJC,EAAWzD,EAAKG,gBAAkBK,EAIjCnB,OAHHoE,IACO,GAAA,YAEJpE,EAAEmE,EACL,CACInE,EAAE,IAAK,CACG,KAAA,IACI,QAACoE,EAAmE,KAAzD9E,EAAE+E,QAAQ1D,EAAKY,iBAAkBN,EAAMC,EAAUC,IACvE+C,GACH,IACAlE,EAAE,WAAY,CACJ,KAAA,IAAKsE,QAAS,WACXC,QAAQ/E,QAAQ,gDAGhBwB,EAAAA,eAAeC,EAAMC,EAAUC,KAEzCnB,EAAE,uBAIVA,OAAAA,EAAE,MAAO,CACZgE,EACAhE,EAAE,iBAAkB,CAACA,EAAE,2BAA4B,CACzC,KAAA,IACGV,QAAAA,EAAE+E,QAAQ1D,EAAK8C,qBAAsBxC,EAAMC,IACrDlB,EAAE,gBAAiB,IAAMR,QAAQ,OAAS,IAAM0B,OAI3D,SAASsD,EAAc7D,GACZrB,OAAAA,EAAE2E,IAAItD,EAAKC,QAAS,SAASK,EAAMwD,GAChCC,IAAAA,EAAe1E,EAAE,SAAU,CACtBiB,MAAAA,EAAK0D,QACF3E,SAAAA,EAAE4E,SAAS,QAAS,SAASC,GAC9BF,EAAAA,QAAUE,KAEpB5F,EAAY6F,SACTC,EAAiB/E,EAAE,SAAU,CACxBiB,MAAAA,EAAK+D,KACFhF,SAAAA,EAAE4E,SAAS,QAAS,SAASC,GAC9BG,EAAAA,KAAOH,KAEjB5F,EAAYgG,WAERjF,OAAAA,EAAE,MAAO,CACD,UAAA,QAAUiB,EAAKiE,QAAU,GAAK,aACpCjE,IAAAA,EAAKkE,IACX,CACCnF,EAAE,mBAAoB,CACjByE,EAAQ,EAAIzE,EAAE,IAAK,CACV,KAAA,IACCR,MAAAA,QAAQ,WACNF,QAAAA,EAAE+E,QAAQ1D,EAAKwC,SAAUlC,GAAO,IAC1CjB,EAAE,qBAAuB,KAC3ByE,EAAQ9D,EAAKC,QAAQwE,OAAS,EAAIpF,EAAE,IAAK,CAChC,KAAA,IACCR,MAAAA,QAAQ,aACNF,QAAAA,EAAE+E,QAAQ1D,EAAKwC,SAAUlC,EAAM,IACzCjB,EAAE,uBAAyB,KAC7BiB,EAAKiE,QACFlF,EAAE,IAAK,CACG,KAAA,IAAKqF,MAAO7F,QAAQ,WAAY8E,QAAS,WACtCY,EAAAA,SAAU,IAEpBlF,EAAE,gBACLA,EAAE,IAAK,CACG,KAAA,IAAKqF,MAAO7F,QAAQ,UAAW8E,QAAS,WACrCY,EAAAA,SAAU,IAEpBlF,EAAE,yBAETA,EAAE,IAAK,CACG,KAAA,IAAKqF,MAAO7F,QAAQ,UAAW8E,QAAS,WACtCC,QAAQ/E,QAAQ,gDACXwD,EAAAA,WAAW/B,KAGzBjB,EAAE,oBAETA,EAAE,iBAAkB,CAChBA,EAAE,YAAaR,QAAQ,MAAOkF,EAAclF,QAAQ,gCACpDqE,EAAiBlD,EAAMM,EAAM,eAEjCjB,EAAE,mBAAoB,CAClBA,EAAE,YAAaR,QAAQ,kCACvBqE,EAAiBlD,EAAMM,EAAM,YAEjCjB,EAAE,gBAAiB,CACfA,EAAE,YAAaR,QAAQ,gBACvBuF,QAMhB,SAASO,EAAuB3E,EAAM4E,GAC3BvF,OAAAA,EAAE,kCAAmC,CAACsE,QAAS3D,EAAK+C,uBAAwB,CAC/E1D,EAAE,0BAA2B,CACzBA,EAAE,YAAauF,EAAUF,OACzBrF,EAAE,mBAAoBV,EAAE2E,IAAI3E,EAAEkG,OAAOlG,EAAEmG,OAAO1G,EAAMwG,EAAUrE,WAAY,QAAS,SAASC,GACjFnB,OAAAA,EAAE,kBAAmB,CAACsE,QAAShF,EAAE+E,QAAQ1D,EAAKgD,2BAA4BxC,EAAKM,aAAc,CAChGzB,EAAE,gBAAiBmB,EAAK+C,MACvB/C,EAAKuE,YAAc1F,EAAE,uBAAwBmB,EAAKuE,aAAe,cAOtF,SAASC,EAAKhF,GACNiF,IAAcL,EAAdK,EAAQ,KAIL5F,OAH2C,QAA7CuF,EAAY5E,EAAKI,0BACVuE,EAAAA,EAAuB3E,EAAM4E,IAElCvF,EAAE,wBAAyB,CAC9BA,EAAE,YAAa,CACXwE,EAAc7D,GACdX,EAAE,uBACFA,EACI,sCACA,CAAC6F,KAAM,IAAKvB,QAAS3D,EAAKuC,YAC1BlD,EAAE,gBAAiB,IAAMR,QAAQ,eAGzCoG,IAIR,SAASE,EAAoBhC,GAClBxE,OAAAA,EAAEkG,OAAOlG,EAAE2E,IAAIH,EAAS,SAASI,EAAMW,GACnC7E,OAAAA,EAAE,SAAU,CAAC6E,MAAOA,GAAQX,KACnC,SAAS6B,GACFA,OAAAA,EAAEC,SAAS,GAAGC,gBAI7B,SAASC,EAAmBC,GACjB7G,OAAAA,EAAE6G,GAAWlC,IAAI,SAAUmC,EAAU3E,GAAoB,MAAA,CAACA,EAAY2E,EAASlC,QAAUmC,YAAYxB,QAGhH,SAASyB,EAAKC,GACCjH,EAAAA,EAAEQ,OAAO,GAAIyG,GAClBC,EAAAA,UAAY3H,EAAS4H,eACrBC,EAAAA,OAAS7H,EAAS8H,YAClBH,EAAAA,UAAYN,EAAmBnH,EAAMyH,WACrCE,EAAAA,OAASR,EAAmBnH,EAAM2H,QAC5B5B,EAAAA,QAAUgB,EAAoBjH,EAASiG,SACvCG,EAAAA,UAAYa,EAAoBjH,EAASoG,WAExCjF,EAAAA,EAAE4G,MAAMzE,SAASL,eAAe,wBAAyB,CACtDpB,WAAAA,EACNiF,KAAAA,IAEHkB,OAAAA,iBAAiB,UAAW,SAASC,GACpCA,EAAM3H,KAAK4H,UACAnE,EAAAA,oBAAoBkE,EAAM3H,KAAK4H,YAE/C,GAGP,SAASC,IACMjE,EAAAA,YAGfnE,OAAOqI,aAAe,CAAA,KAAA,EAAA,KAAA,EAAA,cAGF,WACRjI,IACE6D,EAAAA,mBACSjB,EAAAA,wBAAuB,GACvBL,EAAAA,iBAAiB,MAC1BuB,EAAAA;;ACzVd,aAHA,QAAA,wBAGA,QAAA","file":"script-editor.map","sourceRoot":"../../../static_src","sourcesContent":["/**\n * This file is part of Shuup.\n *\n * Copyright (c) 2012-2018, Shuup Inc. All rights reserved.\n *\n * This source code is licensed under the OSL-3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n// IMPORTANT: This script assumes that lodash and mithriljs@0.2.0\n// are available in global scope, installed from Shuup Admin static source\nconst Messages = window.Messages;\n\nvar settings = {};\nconst names = {};\nconst infos = {};\nvar controller = null;\nconst optionLists = {};\n\nfunction showSuccessAndError(data) {\n    if (data.error) {\n        Messages.enqueue({\n            text: _.isString(data.error) ? data.error : gettext(\"An error occurred.\"),\n            tags: \"error\"\n        });\n    }\n    if (data.success) {\n        Messages.enqueue({\n            text: _.isString(data.success) ? data.success : gettext(\"Success.\"),\n            tags: \"success\"\n        });\n    }\n}\n\nfunction apiRequest(command, data, options) {\n    const request = _.extend({}, {\"command\": command}, data || {});\n    const req = m.request(_.extend({\n        method: \"POST\",\n        url: settings.apiUrl,\n        data: request,\n        config: function(xhr) {\n            xhr.setRequestHeader(\"X-CSRFToken\", window.ShuupAdminConfig.csrf);\n        }\n    }, options));\n    req.then(function(response) {\n        showSuccessAndError(response);\n    }, function() {\n        Messages.enqueue({text: gettext(\"An unspecified error occurred.\"), tags: \"error\"});\n    });\n    return req;\n}\n\nfunction Controller() {\n    const ctrl = this;\n    ctrl.steps = m.prop([]);\n    ctrl.currentItem = m.prop(null);\n    ctrl.newStepItemModalInfo = m.prop(null);\n\n    apiRequest(\"getData\").then(function(data) {\n        ctrl.steps(data.steps);\n    });\n\n    ctrl.removeStepItem = function(step, itemType, item) {\n        const listName = itemType + \"s\";\n        step[listName] = _.reject(step[listName], function(i) {\n            return i === item;\n        });\n        if (ctrl.currentItem() === item) {\n            ctrl.activateStepItem(null, null, null);\n        }\n    };\n\n    ctrl.addStepItem = function(step, itemType, identifier, activateForEdit) {\n        const item = {\"identifier\": identifier};\n        const listName = itemType + \"s\";\n        step[listName].push(item);\n        if (activateForEdit) {\n            ctrl.activateStepItem(step, itemType, item);\n        }\n    };\n    ctrl.setStepItemEditorState = function(state) {\n        if (state) {\n            document.getElementById(\"step-item-wrapper\").style.display = \"block\";\n        } else {\n            document.getElementById(\"step-item-wrapper\").style.display = \"none\";\n            document.getElementById(\"step-item-frame\").src = \"about:blank\";\n        }\n    };\n    ctrl.activateStepItem = function(step, itemType, item) {\n        if (step && item) {\n            ctrl.currentItem(item);\n            const frm = _.extend(document.createElement(\"form\"), {\n                target: \"step-item-frame\",\n                method: \"POST\",\n                action: settings.itemEditorUrl\n            });\n            frm.appendChild(_.extend(document.createElement(\"input\"), {\n                name: \"init_data\",\n                type: \"hidden\",\n                value: JSON.stringify({\n                    eventIdentifier: settings.eventIdentifier,\n                    itemType: itemType,\n                    data: item\n                })\n            }));\n            document.body.appendChild(frm);\n            frm.submit();\n            ctrl.setStepItemEditorState(true);\n        } else {\n            ctrl.currentItem(null);\n            ctrl.setStepItemEditorState(false);\n        }\n    };\n    ctrl.receiveItemEditData = function(data) {\n        const currentItem = ctrl.currentItem();\n        if (!currentItem) {\n            alert(gettext(\"Unexpected edit data received.\"));\n            return;\n        }\n        m.startComputation();\n        ctrl.currentItem(_.extend(currentItem, data));\n        m.endComputation();\n    };\n    ctrl.saveState = function() {\n        apiRequest(\"saveData\", {\n            steps: ctrl.steps()\n        });\n\n        // TODO: Handle errors here?\n    };\n    ctrl.deleteStep = function(step) {\n        ctrl.steps(_.reject(ctrl.steps(), function(s) {\n            return s === step;\n        }));\n    };\n    ctrl.addNewStep = function() {\n        const step = {\n            actions: [],\n            conditions: [],\n            enabled: true,\n            next: \"continue\",\n            condOp: \"and\"\n        };\n        const steps = ctrl.steps();\n        steps.push(step);\n        ctrl.steps(steps);\n    };\n    ctrl.moveStep = function(step, delta) {\n        const steps = ctrl.steps();\n        const oldIndex = _.indexOf(steps, step);\n        if (oldIndex === -1) {\n            return false;\n        }\n        const newIndex = oldIndex + delta;\n        steps.splice(newIndex, 0, steps.splice(oldIndex, 1)[0]);\n        ctrl.steps(steps);\n    };\n    ctrl.promptForNewStepItem = function(step, itemType) {\n        ctrl.newStepItemModalInfo({\n            step: step,\n            itemType: itemType,\n            title: gettext(\"Add new\") + \" \" + itemType\n        });\n    };\n    ctrl.closeNewStepItemModal = function() {\n        ctrl.newStepItemModalInfo(null);\n    };\n    ctrl.createNewStepItemFromModal = function(identifier) {\n        const info = ctrl.newStepItemModalInfo();\n        ctrl.closeNewStepItemModal();\n        if (info === null) {\n            return;\n        }\n        ctrl.addStepItem(info.step, info.itemType, identifier, true);\n    };\n}\n\nfunction workflowItemList(ctrl, step, itemType) {\n    const listName = itemType + \"s\";\n    const nameMap = names[itemType];\n    const items = step[listName];\n    const list = m(\"ul.action-list\", items.map(function(item) {\n        const name = nameMap[item.identifier] || item.identifier;\n        var tag = \"li\";\n        const current = (ctrl.currentItem() === item);\n        if (current) {\n            tag += \".current\";\n        }\n        return m(tag,\n            [\n                m(\"a\", {\n                    href: \"#\",\n                    onclick: (!current ? _.partial(ctrl.activateStepItem, step, itemType, item) : null)\n                }, name),\n                \" \",\n                m(\"a.delete\", {\n                    href: \"#\", onclick: function() {\n                        if (!confirm(gettext(\"Delete this item?\\nThis can not be undone.\"))) {\n                            return;\n                        }\n                        ctrl.removeStepItem(step, itemType, item);\n                    }\n                }, m(\"i.fa.fa-trash\"))\n            ]\n        );\n    }));\n    return m(\"div\", [\n        list,\n        m(\"div.action-new\", [m(\"a.btn.btn-xs.btn-primary\", {\n            href: \"#\",\n            onclick: _.partial(ctrl.promptForNewStepItem, step, itemType)\n        }, m(\"i.fa.fa-plus\"), \" \" + gettext(\"New\") + \" \" + itemType)])\n    ]);\n}\n\nfunction stepTableRows(ctrl) {\n    return _.map(ctrl.steps(), function(step, index) {\n        const condOpSelect = m(\"select\", {\n            value: step.cond_op,\n            onchange: m.withAttr(\"value\", function(value) {\n                step.cond_op = value;  // eslint-disable-line camelcase\n            })\n        }, optionLists.condOps);\n        const stepNextSelect = m(\"select\", {\n            value: step.next,\n            onchange: m.withAttr(\"value\", function(value) {\n                step.next = value;\n            })\n        }, optionLists.stepNexts);\n\n        return m(\"div\", {\n            className: \"step\" + (step.enabled ? \"\" : \" disabled\"),\n            key: step.id\n        }, [\n            m(\"div.step-buttons\", [\n                (index > 0 ? m(\"a\", {\n                    href: \"#\",\n                    title: gettext(\"Move Up\"),\n                    onclick: _.partial(ctrl.moveStep, step, -1)\n                }, m(\"i.fa.fa-caret-up\")) : null),\n                (index < ctrl.steps().length - 1 ? m(\"a\", {\n                    href: \"#\",\n                    title: gettext(\"Move Down\"),\n                    onclick: _.partial(ctrl.moveStep, step, +1)\n                }, m(\"i.fa.fa-caret-down\")) : null),\n                (step.enabled ?\n                    m(\"a\", {\n                        href: \"#\", title: gettext(\"Disable\"), onclick: function() {\n                            step.enabled = false;\n                        }\n                    }, m(\"i.fa.fa-ban\")) :\n                    m(\"a\", {\n                        href: \"#\", title: gettext(\"Enable\"), onclick: function() {\n                            step.enabled = true;\n                        }\n                    }, m(\"i.fa.fa-check-circle\"))\n                ),\n                m(\"a\", {\n                    href: \"#\", title: gettext(\"Delete\"), onclick: function() {\n                        if (confirm(gettext(\"Are you sure you wish to delete this step?\"))) {\n                            ctrl.deleteStep(step);\n                        }\n                    }\n                }, m(\"i.fa.fa-trash\"))\n            ]),\n            m(\"div.step-conds\", [\n                m(\"span.hint\", gettext(\"If\"), condOpSelect, gettext(\"of these conditions hold...\")),\n                workflowItemList(ctrl, step, \"condition\")\n            ]),\n            m(\"div.step-actions\", [\n                m(\"span.hint\", gettext(\"then execute these actions...\")),\n                workflowItemList(ctrl, step, \"action\")\n            ]),\n            m(\"div.step-next\", [\n                m(\"span.hint\", gettext(\"and then...\")),\n                stepNextSelect\n            ])\n        ]);\n    });\n}\n\nfunction renderNewStepItemModal(ctrl, modalInfo) {\n    return m(\"div.new-step-item-modal-overlay\", {onclick: ctrl.closeNewStepItemModal}, [\n        m(\"div.new-step-item-modal\", [\n            m(\"div.title\", modalInfo.title),\n            m(\"div.item-options\", _.map(_.sortBy(_.values(infos[modalInfo.itemType]), \"name\"), function(item) {\n                return m(\"div.item-option\", {onclick: _.partial(ctrl.createNewStepItemFromModal, item.identifier)}, [\n                    m(\"div.item-name\", item.name),\n                    (item.description ? m(\"div.item-description\", item.description) : null)\n                ]);\n            }))\n        ])\n    ]);\n}\n\nfunction view(ctrl) {\n    var modal = null, modalInfo = null;\n    if ((modalInfo = ctrl.newStepItemModalInfo()) !== null) {\n        modal = renderNewStepItemModal(ctrl, modalInfo);\n    }\n    return m(\"div.step-list-wrapper\", [\n        m(\"div.steps\", [\n            stepTableRows(ctrl),\n            m(\"hr.script-separator\"),\n            m(\n                \"a.new-step-link.btn.btn-info.btn-sm\",\n                {href: \"#\", onclick: ctrl.addNewStep},\n                m(\"i.fa.fa-plus\"), \" \" + gettext(\"New step\")\n            )\n        ]),\n        modal\n    ]);\n}\n\nfunction generateItemOptions(nameMap) {\n    return _.sortBy(_.map(nameMap, function(name, value) {\n        return m(\"option\", {value: value}, name);\n    }), function(o) {\n        return o.children[0].toLowerCase();\n    });\n}\n\nfunction itemInfosToNameMap(itemInfos) {\n    return _(itemInfos).map(function (itemInfo, identifier){ return [identifier, itemInfo.name]; }).zipObject().value();\n}\n\nfunction init(iSettings) {\n    settings = _.extend({}, iSettings);\n    infos.condition = settings.conditionInfos;\n    infos.action = settings.actionInfos;\n    names.condition = itemInfosToNameMap(infos.condition);\n    names.action = itemInfosToNameMap(infos.action);\n    optionLists.condOps = generateItemOptions(settings.condOps);\n    optionLists.stepNexts = generateItemOptions(settings.stepNexts);\n\n    controller = m.mount(document.getElementById(\"step-table-container\"), {\n        controller: Controller,\n        view: view\n    });\n    window.addEventListener(\"message\", function(event) {\n        if (event.data.new_data) {\n            controller.receiveItemEditData(event.data.new_data);\n        }\n    }, false);\n}\n\nfunction save() {\n    controller.saveState();\n}\n\nwindow.ScriptEditor = {\n    init,\n    save,\n    hideEditModal() {\n        if (controller) {\n            m.startComputation();\n            controller.setStepItemEditorState(false);\n            controller.activateStepItem(null);  // Deactivate the modal once data is received\n            m.endComputation();\n        }\n    }\n};\n","/**\n * This file is part of Shuup.\n *\n * Copyright (c) 2012-2018, Shuup Inc. All rights reserved.\n *\n * This source code is licensed under the OSL-3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n // styles\nimport \"./script-editor.less\";\n\n// scripts\nimport \"./script-editor.js\";\n"]}