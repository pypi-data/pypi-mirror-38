{"version":3,"sources":["product-variation-variable-editor.js"],"names":["window","VariationVariableEditor","m","_","variables","ctrlSingleton","controller","this","showIdentifierFields","prop","config","el","variableWrap","index","valuesTables","document","getElementById","getElementsByClassName","length","Sortable","create","group","handle","onEnd","event","reindex","refreshField","forEach","call","itemId","item","getAttribute","newIndex","currentVariable","varIndex","valIndex","values","currentValue","value","JSON","stringify","newPk","Math","random","getIdfrAndLanguagesCells","cellSelector","object","langKey","langLabelFormat","arguments","undefined","changeIdentifier","withAttr","code","map","languages","_ref","name","changeXlate","partial","label","placeholder","changeXlateP","oninput","onchange","identifier","gettext","sortingHandle","className","valueTr","ctrl","rowLabel","interpolate","data-id","href","onclick","DELETE","renderVariable","variable","deleteVariableButton","confirm","addValueButton","nameRow","concat","bodyRows","push","reject","texts","preventDefault","view","variablesDiv","key","pk","id","identifierFieldsCheckbox","type","checked","names","options","Array","prototype","oldIndex","splice","init","mount"],"mappings":"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","file":"product-variation-variable-editor.js","sourcesContent":["/**\n * This file is part of Shuup.\n *\n * Copyright (c) 2012-2018, Shuup Inc. All rights reserved.\n *\n * This source code is licensed under the OSL-3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\nwindow.VariationVariableEditor = (function(m, _) {\n    \"use strict\";\n    var languages = null;\n    var variables = null;\n    var ctrlSingleton = null;\n\n    /**\n     * Adapted from https://www.npmjs.com/package/array.prototype.move\n     */\n    if(!Array.prototype.reindex) {\n        Array.prototype.reindex = function (oldIndex, newIndex) {\n            this.splice(newIndex, 0, this.splice(oldIndex, 1)[0]);\n        };\n    }\n\n    function controller() {\n        this.showIdentifierFields = m.prop(false);\n\n    }\n\n    function config(el) {\n        variableSortableSetup();\n        valueSortableSetup();\n    }\n\n    function refreshField() {\n        document.getElementById(\"id_variables-data\").value = JSON.stringify(variables);\n    }\n\n    function newPk() {\n        return \"$\" + Math.random();\n    }\n\n    function getIdfrAndLanguagesCells(cellSelector, object, langKey, langLabelFormat=\"$\", showIdentifierFields=true) {\n        const changeIdentifier = m.withAttr(\"value\", (value) => {\n            object.identifier = value; refreshField();\n        });\n        const changeXlate = (code, value) => {\n            object[langKey][code] = value; refreshField();\n        };\n        return [\n            _.map(languages, ({name, code}) => {\n                const changeXlateP = m.withAttr(\"value\", _.partial(changeXlate, code));\n                const label = langLabelFormat.replace(\"$\", name);\n                return m(cellSelector, [\n                    (label && label.length ? m(\"label\", label) : null),\n                    m(\"input.form-control\", {\n                        value: object[langKey][code] || \"\",\n                        placeholder: label,\n                        oninput: changeXlateP,\n                        onchange: changeXlateP\n                    })\n                ]);\n            }),\n            (showIdentifierFields ? m(cellSelector, [\n                m(\"input.form-control\", {\n                    value: object.identifier,\n                    placeholder: gettext(\"Identifier\"),\n                    oninput: changeIdentifier,\n                    onchange: changeIdentifier\n                })\n            ]) : null),\n        ];\n    }\n\n    /**\n     * Sets up Sortable on the variation variables\n     */\n    function variableSortableSetup() {\n        const variableWrap = document.getElementById(\"product-variable-wrap\");\n        if (document.getElementsByClassName(\"variable-sort-handle\").length > 0) {\n            Sortable.create(variableWrap, {\n              group: \"variable-sort\",\n              handle: \".variable-sort-handle\",\n              onEnd: function (event) {\n                  variables.reindex(event.oldIndex, event.newIndex);\n                  refreshField();\n              }\n            });\n        }\n    }\n\n    /**\n     * Sets up Sortable on the variation values\n     */\n    function valueSortableSetup(index) {\n        const valuesTables = document.getElementsByClassName('product-variable-values');\n        var index = 0;\n        [].forEach.call(valuesTables, function (el) {\n            Sortable.create(el, {\n                group: \"value-sort-\" + index,\n                handle: \".value-sort-handle\",\n                onEnd: function (event) {\n                    // The event.oldIndex is unreliable, it seems to be an\n                    // issue with nested sortables. The oldIndex is the one\n                    // from the parent sortable.\n                    const itemId = event.item.getAttribute('data-id');\n                    const newIndex = event.newIndex;\n                    var currentVariable = null;\n                    var currentValue = null;\n                    for(var varIndex=0; varIndex < variables.length; varIndex++) {\n                        currentVariable = variables[varIndex];\n                        for(var valIndex=0; valIndex < currentVariable.values.length; valIndex++) {\n                            currentValue = currentVariable.values[valIndex];\n                            if(currentValue.pk == itemId) {\n                                variables[varIndex].values.reindex(valIndex, newIndex);\n                            }\n                        }\n                    }\n                    refreshField();\n                }\n            });\n            index = index + 1;\n        });\n    }\n\n    /**\n     *  Return the sorting handle component\n     */\n    function sortingHandle(className) {\n        return m(\"i.fa.fa-bars.\" + className + \".pull-left\", \"\");\n    }\n\n    function valueTr(ctrl, value, index) {\n        const showIdentifierFields = ctrl.showIdentifierFields();\n        const rowLabel = interpolate(gettext(\"Value %s Name\"), [(index + 1)]);\n        return m(\"tr\", {'data-id': value.pk},\n            m(\"th\", [sortingHandle(\"value-sort-handle\"), rowLabel]),\n            getIdfrAndLanguagesCells(\"td\", value, \"texts\", \"\", showIdentifierFields),\n            m(\"td\", m(\"a.btn.text-danger.btn-xs\", {href: \"#\", onclick: () => {\n                value.DELETE = true;\n                refreshField();\n                return false;\n            }}, m(\"i.fa.fa-times-circle\"), \" \" + gettext(\"Delete value\")))\n        );\n    }\n\n    function renderVariable(ctrl, variable) {\n        const showIdentifierFields = ctrl.showIdentifierFields();\n        const deleteVariableButton = m(\"a.btn.btn-xs.text-danger\", {href: \"#\", onclick: () => {\n            if (variable.values.length === 0 || confirm(gettext(\"Are you sure?\"))) {\n                variable.DELETE = true;\n                refreshField();\n                return false;\n            }\n        }}, m(\"i.fa.fa-times-circle\"), \" \" + gettext(\"Delete Variable\"));\n        const addValueButton = m(\"a.btn.btn-xs.btn-text\", {href: \"#\", onclick: (event) => {\n            variable.values.push({pk: newPk(), identifier: \"\", texts: {}});\n            event.preventDefault();\n        }}, m(\"i.fa.fa-plus\"), \" \" + gettext(\"Add new value\"));\n        const nameRow = m(\"tr\", [m(\"th\", gettext(\"Variable Name\"))].concat(\n                getIdfrAndLanguagesCells(\"td\", variable, \"names\", \"\", showIdentifierFields)\n            ).concat([m(\"td\")])\n        );\n        const bodyRows = _.map(_.reject(variable.values, \"DELETE\"), _.partial(valueTr, ctrl));\n        return m(\"div.product-variable\", {key: variable.pk}, [\n            m(\"div.variable-heading.clearfix\", [\n                sortingHandle(\"variable-sort-handle\"),\n                m(\"h3.pull-left\", gettext(\"Variable\")),\n                m(\"div.pull-right\", deleteVariableButton)\n            ]),\n            m(\"div.variable-body\", [\n                m(\"div.table-responsive\", [\n                    m(\"table.table.table-bordered\", [\n                        m(\"thead\", [\n                            m(\"tr\", [m(\"th\")].concat(\n                                _.map(languages, ({name}) => m(\"th\", name))\n                            ).concat([\n                                showIdentifierFields ? m(\"th\", [\n                                    gettext(\"Identifer\")\n                                ]) : null,\n                                m(\"th\")\n                            ])),\n                        ]),\n                        m(\"tbody.product-variable-name\", nameRow),\n                        m(\"tbody.product-variable-values\", bodyRows)\n                    ])\n                ]),\n                m(\"div.new-row\", addValueButton)\n            ])\n        ]);\n    }\n\n    function view(ctrl) {\n        var variablesDiv = m(\n            \"div.product-variable-wrap\", {id: \"product-variable-wrap\"},\n            _.map(_.reject(variables, \"DELETE\"), _.partial(renderVariable, ctrl))\n        );\n        var identifierFieldsCheckbox = m(\"p\", [\n            m(\"label.small\", [\n                m(\"input\", {\n                    type: \"checkbox\",\n                    checked: !!ctrl.showIdentifierFields(),\n                    onclick: m.withAttr(\"checked\", ctrl.showIdentifierFields)\n                }),\n                \" \" + gettext(\"Show identifier fields (for advanced users)\")\n            ])\n        ]);\n        if (!variables.length) {\n            variablesDiv = m(\"p.text-info\", [\n                m(\"i.fa.fa-exclamation-circle\"), \" \" + gettext(\"There are no variables defined.\"),\n                m(\"hr\")\n            ]);\n            identifierFieldsCheckbox = null;\n        }\n        return m(\"div\", {config: config}, [\n            identifierFieldsCheckbox,\n            m(\"hr\"),\n            variablesDiv,\n            m(\"a.btn.btn-lg.btn-text\", {href: \"#\", onclick: (event) => {\n                variables.push({pk: newPk(), identifier: \"\", names: {}, values: []});\n                event.preventDefault();\n            }}, m(\"i.fa.fa-plus\"), \" \" + gettext(\"Add new variable\"))\n        ]);\n    }\n\n    function init(options) {\n        if (ctrlSingleton) {\n            return;\n        }\n        languages = options.languages;\n        variables = options.variables;\n        window.VariationVariableEditor.ctrl = ctrlSingleton = m.mount(\n            document.getElementById(\"variation-variable-editor\"),\n            {controller: controller, view: view}\n        );\n    }\n    return {init: init};\n}(window.m, window._));\n\n"]}