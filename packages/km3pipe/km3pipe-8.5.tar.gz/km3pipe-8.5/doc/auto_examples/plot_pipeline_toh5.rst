

.. _sphx_glr_auto_examples_plot_pipeline_toh5.py:


======================
ToHDF5 Pipeline example
======================




.. code-block:: python


    # Authors: Moritz Lotze <mlotze@km3net.de>
    # License: BSD-3
    # Date: 2018-07-12
    # Status: Under construction...

    from __future__ import absolute_import, print_function, division

    import tables as tb

    from km3pipe import Pipeline
    from km3pipe.io import EvtPump, HDF5Sink

    from km3modules.common import StatusBar







Preparation
-----------
Let's define the inputs / outputs first -- those would be coming from a CLI
parser in practice.



.. code-block:: python


    N_EVENTS = 200000
    IN_FNAME = 'data/numu_cc.evt'
    OUT_FNAME = 'data/numu_cc.h5'







Also, in this case we don't really want to dump the data onto disk, so we
create an in-memory-ony file, and pass it as the ``h5file`` arg to the
hdf5sink. to actually write out a file, just specify an outfile name
(commented out here).



.. code-block:: python


    OUTFILE = tb.open_file(
        # create the file in memory only
        OUT_FNAME,
        'w',
        driver="H5FD_CORE",
        driver_core_backing_store=0,
    )







Setting up the pipeline
-----------------------



.. code-block:: python


    pipe = Pipeline(timeit=True)
    pipe.attach(EvtPump, filename=IN_FNAME)
    pipe.attach(StatusBar, every=25)
    pipe.attach(
        HDF5Sink,
        # filename=OUT_FNAME,
        h5file=OUTFILE,
    )





.. rst-class:: sphx-glr-script-out

 Out::

    km3pipe.io.evt.EvtPump: Automatic tag parsing enabled.
    km3pipe.io.evt.EvtPump: Opening data/numu_cc.evt


Draining the pipeline
---------------------



.. code-block:: python


    pipe.drain(N_EVENTS)




.. rst-class:: sphx-glr-script-out

 Out::

    Pipeline and module initialisation took 0.003s (CPU 0.002s).
    --------------------------[ Blob      25 ]---------------------------
    --------------------------[ Blob      50 ]---------------------------
    --------------------------[ Blob      75 ]---------------------------
    --------------------------[ Blob     100 ]---------------------------
    ================================[ . ]================================
    km3pipe.io.hdf5.HDF5Sink: HDF5 file written to: dump.h5
    ============================================================
    109 cycles drained in 3.920528s (CPU 3.662133s). Memory peak: 141.09 MB
      wall  mean: 0.035333s  medi: 0.032927s  min: 0.028364s  max: 0.068897s  std: 0.006939s
      CPU   mean: 0.033249s  medi: 0.031373s  min: 0.027381s  max: 0.058624s  std: 0.005625s
    EvtPump - process: 3.655s (CPU 3.445s) - finish: 0.000s (CPU 0.000s)
      wall  mean: 0.033528s  medi: 0.031283s  min: 0.023892s  max: 0.066903s  std: 0.006793s
      CPU   mean: 0.031608s  medi: 0.029929s  min: 0.022324s  max: 0.056631s  std: 0.005593s
    StatusBar - process: 0.000s (CPU 0.000s) - finish: 0.000s (CPU 0.000s)
      wall  mean: 0.000041s  medi: 0.000041s  min: 0.000040s  max: 0.000043s  std: 0.000001s
      CPU   mean: 0.000042s  medi: 0.000042s  min: 0.000040s  max: 0.000043s  std: 0.000001s
    HDF5Sink - process: 0.169s (CPU 0.152s) - finish: 0.052s (CPU 0.024s)
      wall  mean: 0.001548s  medi: 0.001270s  min: 0.001108s  max: 0.023357s  std: 0.002111s
      CPU   mean: 0.001391s  medi: 0.001271s  min: 0.001110s  max: 0.008987s  std: 0.000757s


**Total running time of the script:** ( 0 minutes  3.944 seconds)



.. only :: html

 .. container:: sphx-glr-footer


  .. container:: sphx-glr-download

     :download:`Download Python source code: plot_pipeline_toh5.py <plot_pipeline_toh5.py>`



  .. container:: sphx-glr-download

     :download:`Download Jupyter notebook: plot_pipeline_toh5.ipynb <plot_pipeline_toh5.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.readthedocs.io>`_
